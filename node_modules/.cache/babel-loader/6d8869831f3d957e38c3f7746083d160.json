{"ast":null,"code":"/**\n * @module bindings/quill\n */\nimport { createMutex } from 'lib0/mutex.js';\nimport * as Y from 'yjs'; // eslint-disable-line\n\nimport { Awareness } from 'y-protocols/awareness.js'; // eslint-disable-line\n\n/**\n * Removes the pending '\\n's if it has no attributes.\n */\n\nexport const normQuillDelta = delta => {\n  if (delta.length > 0) {\n    const d = delta[delta.length - 1];\n    const insert = d.insert;\n\n    if (d.attributes === undefined && insert !== undefined && insert.slice(-1) === '\\n') {\n      delta = delta.slice();\n      let ins = insert.slice(0, -1);\n\n      while (ins.slice(-1) === '\\n') {\n        ins = ins.slice(0, -1);\n      }\n\n      delta[delta.length - 1] = {\n        insert: ins\n      };\n\n      if (ins.length === 0) {\n        delta.pop();\n      }\n\n      return delta;\n    }\n  }\n\n  return delta;\n};\n/**\n * @param {any} quillCursors\n */\n\nconst updateCursor = (quillCursors, aw, clientId, doc, type) => {\n  try {\n    if (aw && aw.cursor && clientId !== doc.clientID) {\n      const user = aw.user || {};\n      const color = user.color || '#ffa500';\n      const name = user.name || `User: ${clientId}`;\n      quillCursors.createCursor(clientId.toString(), name, color);\n      const anchor = Y.createAbsolutePositionFromRelativePosition(Y.createRelativePositionFromJSON(aw.cursor.anchor), doc);\n      const head = Y.createAbsolutePositionFromRelativePosition(Y.createRelativePositionFromJSON(aw.cursor.head), doc);\n\n      if (anchor && head && anchor.type === type) {\n        quillCursors.moveCursor(clientId.toString(), {\n          index: anchor.index,\n          length: head.index - anchor.index\n        });\n      }\n    } else {\n      quillCursors.removeCursor(clientId.toString());\n    }\n  } catch (err) {\n    console.error(err);\n  }\n};\n\nexport class QuillBinding {\n  /**\n   * @param {Y.Text} type\n   * @param {any} quill\n   * @param {Awareness} [awareness]\n   */\n  constructor(type, quill, awareness) {\n    const mux = createMutex();\n    const doc =\n    /** @type {Y.Doc} */\n    type.doc;\n    this.mux = mux;\n    this.type = type;\n    this.doc = doc;\n    this.quill = quill;\n    const quillCursors = quill.getModule('cursors') || null;\n    this.quillCursors = quillCursors; // This object contains all attributes used in the quill instance\n\n    this._negatedUsedFormats = {};\n    this.awareness = awareness;\n\n    this._awarenessChange = ({\n      added,\n      removed,\n      updated\n    }) => {\n      const states =\n      /** @type {Awareness} */\n      awareness.getStates();\n      added.forEach(id => {\n        updateCursor(quillCursors, states.get(id), id, doc, type);\n      });\n      updated.forEach(id => {\n        updateCursor(quillCursors, states.get(id), id, doc, type);\n      });\n      removed.forEach(id => {\n        quillCursors.removeCursor(id.toString());\n      });\n    };\n\n    this._typeObserver = event => {\n      mux(() => {\n        const eventDelta = event.delta; // We always explicitly set attributes, otherwise concurrent edits may\n        // result in quill assuming that a text insertion shall inherit existing\n        // attributes.\n\n        const delta = [];\n\n        for (let i = 0; i < eventDelta.length; i++) {\n          const d = eventDelta[i];\n\n          if (d.insert !== undefined) {\n            delta.push(Object.assign({}, d, {\n              attributes: Object.assign({}, this._negatedUsedFormats, d.attributes || {})\n            }));\n          } else {\n            delta.push(d);\n          }\n        }\n\n        quill.updateContents(delta, 'yjs');\n      });\n    };\n\n    type.observe(this._typeObserver);\n\n    this._quillObserver = (eventType, delta) => {\n      if (delta && delta.ops) {\n        // update content\n        const ops = delta.ops;\n        ops.forEach(op => {\n          if (op.attributes !== undefined) {\n            for (let key in op.attributes) {\n              if (this._negatedUsedFormats[key] === undefined) {\n                this._negatedUsedFormats[key] = false;\n              }\n            }\n          }\n        });\n        mux(() => {\n          type.applyDelta(ops);\n        });\n      } // always check selection\n\n\n      if (awareness && quillCursors) {\n        const sel = quill.getSelection();\n        const aw =\n        /** @type {any} */\n        awareness.getLocalState();\n\n        if (sel === null) {\n          if (awareness.getLocalState() !== null) {\n            awareness.setLocalStateField('cursor',\n            /** @type {any} */\n            null);\n          }\n        } else {\n          const anchor = Y.createRelativePositionFromTypeIndex(type, sel.index);\n          const head = Y.createRelativePositionFromTypeIndex(type, sel.index + sel.length);\n\n          if (!aw || !aw.cursor || !Y.compareRelativePositions(anchor, aw.cursor.anchor) || !Y.compareRelativePositions(head, aw.cursor.head)) {\n            awareness.setLocalStateField('cursor', {\n              anchor,\n              head\n            });\n          }\n        } // update all remote cursor locations\n\n\n        awareness.getStates().forEach((aw, clientId) => {\n          updateCursor(quillCursors, aw, clientId, doc, type);\n        });\n      }\n    };\n\n    quill.on('editor-change', this._quillObserver);\n    mux(() => {\n      // This indirectly initializes _negatedUsedFormats.\n      // Make sure that this call this after the _quillObserver is set.\n      quill.setContents(type.toDelta());\n    }); // init remote cursors\n\n    if (quillCursors !== null && awareness) {\n      awareness.getStates().forEach((aw, clientId) => {\n        updateCursor(quillCursors, aw, clientId, doc, type);\n      });\n      awareness.on('change', this._awarenessChange);\n    }\n  }\n\n  destroy() {\n    this.type.unobserve(this._typeObserver);\n    this.quill.off('editor-change', this._quillObserver);\n\n    if (this.awareness) {\n      this.awareness.off('change', this._awarenessChange);\n    }\n  }\n\n}","map":{"version":3,"sources":["/home/aksaakov/Projects/collaborative-editor/node_modules/y-quill/src/y-quill.js"],"names":["createMutex","Y","Awareness","normQuillDelta","delta","length","d","insert","attributes","undefined","slice","ins","pop","updateCursor","quillCursors","aw","clientId","doc","type","cursor","clientID","user","color","name","createCursor","toString","anchor","createAbsolutePositionFromRelativePosition","createRelativePositionFromJSON","head","moveCursor","index","removeCursor","err","console","error","QuillBinding","constructor","quill","awareness","mux","getModule","_negatedUsedFormats","_awarenessChange","added","removed","updated","states","getStates","forEach","id","get","_typeObserver","event","eventDelta","i","push","Object","assign","updateContents","observe","_quillObserver","eventType","ops","op","key","applyDelta","sel","getSelection","getLocalState","setLocalStateField","createRelativePositionFromTypeIndex","compareRelativePositions","on","setContents","toDelta","destroy","unobserve","off"],"mappings":"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","sourcesContent":["/**\n * @module bindings/quill\n */\n\nimport { createMutex } from 'lib0/mutex.js'\nimport * as Y from 'yjs' // eslint-disable-line\nimport { Awareness } from 'y-protocols/awareness.js' // eslint-disable-line\n\n/**\n * Removes the pending '\\n's if it has no attributes.\n */\nexport const normQuillDelta = delta => {\n  if (delta.length > 0) {\n    const d = delta[delta.length - 1]\n    const insert = d.insert\n    if (d.attributes === undefined && insert !== undefined && insert.slice(-1) === '\\n') {\n      delta = delta.slice()\n      let ins = insert.slice(0, -1)\n      while (ins.slice(-1) === '\\n') {\n        ins = ins.slice(0, -1)\n      }\n      delta[delta.length - 1] = { insert: ins }\n      if (ins.length === 0) {\n        delta.pop()\n      }\n      return delta\n    }\n  }\n  return delta\n}\n\n/**\n * @param {any} quillCursors\n */\nconst updateCursor = (quillCursors, aw, clientId, doc, type) => {\n  try {\n    if (aw && aw.cursor && clientId !== doc.clientID) {\n      const user = aw.user || {}\n      const color = user.color || '#ffa500'\n      const name = user.name || `User: ${clientId}`\n      quillCursors.createCursor(clientId.toString(), name, color)\n      const anchor = Y.createAbsolutePositionFromRelativePosition(Y.createRelativePositionFromJSON(aw.cursor.anchor), doc)\n      const head = Y.createAbsolutePositionFromRelativePosition(Y.createRelativePositionFromJSON(aw.cursor.head), doc)\n      if (anchor && head && anchor.type === type) {\n        quillCursors.moveCursor(clientId.toString(), { index: anchor.index, length: head.index - anchor.index })\n      }\n    } else {\n      quillCursors.removeCursor(clientId.toString())\n    }\n  } catch (err) {\n    console.error(err)\n  }\n}\n\nexport class QuillBinding {\n  /**\n   * @param {Y.Text} type\n   * @param {any} quill\n   * @param {Awareness} [awareness]\n   */\n  constructor (type, quill, awareness) {\n    const mux = createMutex()\n    const doc = /** @type {Y.Doc} */ (type.doc)\n    this.mux = mux\n    this.type = type\n    this.doc = doc\n    this.quill = quill\n    const quillCursors = quill.getModule('cursors') || null\n    this.quillCursors = quillCursors\n    // This object contains all attributes used in the quill instance\n    this._negatedUsedFormats = {}\n    this.awareness = awareness\n    this._awarenessChange = ({ added, removed, updated }) => {\n      const states = /** @type {Awareness} */ (awareness).getStates()\n      added.forEach(id => {\n        updateCursor(quillCursors, states.get(id), id, doc, type)\n      })\n      updated.forEach(id => {\n        updateCursor(quillCursors, states.get(id), id, doc, type)\n      })\n      removed.forEach(id => {\n        quillCursors.removeCursor(id.toString())\n      })\n    }\n    this._typeObserver = event => {\n      mux(() => {\n        const eventDelta = event.delta\n        // We always explicitly set attributes, otherwise concurrent edits may\n        // result in quill assuming that a text insertion shall inherit existing\n        // attributes.\n        const delta = []\n        for (let i = 0; i < eventDelta.length; i++) {\n          const d = eventDelta[i]\n          if (d.insert !== undefined) {\n            delta.push(Object.assign({}, d, { attributes: Object.assign({}, this._negatedUsedFormats, d.attributes || {}) }))\n          } else {\n            delta.push(d)\n          }\n        }\n        quill.updateContents(delta, 'yjs')\n      })\n    }\n    type.observe(this._typeObserver)\n    this._quillObserver = (eventType, delta) => {\n      if (delta && delta.ops) {\n        // update content\n        const ops = delta.ops\n        ops.forEach(op => {\n          if (op.attributes !== undefined) {\n            for (let key in op.attributes) {\n              if (this._negatedUsedFormats[key] === undefined) {\n                this._negatedUsedFormats[key] = false\n              }\n            }\n          }\n        })\n        mux(() => {\n          type.applyDelta(ops)\n        })\n      }\n      // always check selection\n      if (awareness && quillCursors) {\n        const sel = quill.getSelection()\n        const aw = /** @type {any} */ (awareness.getLocalState())\n        if (sel === null) {\n          if (awareness.getLocalState() !== null) {\n            awareness.setLocalStateField('cursor', /** @type {any} */ (null))\n          }\n        } else {\n          const anchor = Y.createRelativePositionFromTypeIndex(type, sel.index)\n          const head = Y.createRelativePositionFromTypeIndex(type, sel.index + sel.length)\n          if (!aw || !aw.cursor || !Y.compareRelativePositions(anchor, aw.cursor.anchor) || !Y.compareRelativePositions(head, aw.cursor.head)) {\n            awareness.setLocalStateField('cursor', {\n              anchor,\n              head\n            })\n          }\n        }\n        // update all remote cursor locations\n        awareness.getStates().forEach((aw, clientId) => {\n          updateCursor(quillCursors, aw, clientId, doc, type)\n        })\n      }\n    }\n    quill.on('editor-change', this._quillObserver)\n    mux(() => {\n      // This indirectly initializes _negatedUsedFormats.\n      // Make sure that this call this after the _quillObserver is set.\n      quill.setContents(type.toDelta())\n    })\n    // init remote cursors\n    if (quillCursors !== null && awareness) {\n      awareness.getStates().forEach((aw, clientId) => {\n        updateCursor(quillCursors, aw, clientId, doc, type)\n      })\n      awareness.on('change', this._awarenessChange)\n    }\n  }\n  destroy () {\n    this.type.unobserve(this._typeObserver)\n    this.quill.off('editor-change', this._quillObserver)\n    if (this.awareness) {\n      this.awareness.off('change', this._awarenessChange)\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}